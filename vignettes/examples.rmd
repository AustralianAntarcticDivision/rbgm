---
title: "rbgm examples"
author: "Michael Sumner"
date: "15 April 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(maptools)
library(rgdal)
library(rbgm)
```

# Preliminaries

Need to install  `devtools` and then use that to install `rbgm` and `bgmfiles` from Github

```{r,eval=FALSE}
install.packages(devtools)  
devtools::install_github("mdsumner/rbgm") 
devtools::install_github("AustralianAntarcticDivision/bgmfiles")


```

(See the Git chapter in the [book **R Packages**](http://r-pkgs.had.co.nz/git.html) for full details on this way of working in R.)


# Using rbgm

With the R package `rbgm` we can read directly from a .bgm file and apply the family of [Spatial tools in R](https://cran.rstudio.com/web/views/Spatial.html). 


## Read a bgm file and plot

```{r}
# worker function used below
# turn +proj into line separated text
breakproj <- function(x) {
  paste(strsplit(x, " ")[[1]], collapse = "\n")
}


library(rbgm)  ## 
library(bgmfiles)
## get all example files
files <- bgmfiles()

library(rgdal)  ## required for the map projection used in BGM

bgm <- bgmfile(files[1])
boxes <- boxSpatial(bgm)
plot(boxes, col = ifelse(boxes$boundary, "#88888880", sample(rainbow(nrow(boxes), alpha = 0.5))))
  op <- par(xpd = NA)
  llgridlines(boxes)
  par(op)
  title(basename(files[1]), cex = 0.8)
  mtext(breakproj(proj4string(boxes)), cex = 0.75, side = 2, las = 1, adj = 0, line = 2, at = par("usr")[3], xpd = NA)
  
```

## Read several example BGM files and plot, include a red marker


```{r}

## package with a map layer
library(maptools)
data(wrld_simpl)

## set up world plot
plot(wrld_simpl, col = "#CCCCCC", bg = "aliceblue", border = NA, asp = "")


for (i in seq_along(files)) {
  bgm <- bgmfile(files[i])
  boxes <- boxSpatial(bgm)  ## get just the boxes as Polygons
  boxesLL <- spTransform(boxes, proj4string(wrld_simpl))  ## un project if needed
  plot(boxesLL, add = TRUE, border = ifelse(boxes$boundary, "#88888880", sample(rainbow(nrow(boxes), alpha = 0.5))))
  pt <- rowMeans(bbox(boxesLL))  ## centre point
  points(pt[1], pt[2], pch = 19, col = "red")
  text(pt[1], pt[2], lab = basename(files[i]), pos = 4, cex = 0.6)
  
}
