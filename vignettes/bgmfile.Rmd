---
title: "BGM files"
author: "Michael Sumner"
date: "24 November 2015"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

scol <- function(alpha = 1) {
    ss <- sample(255, 3, replace = TRUE)
    rgb(ss[1], ss[2], ss[2], max = 255)
}

m2 <- function(x) {
 if (length(x) == 2) matrix(x, ncol = 2) else x
}
meanxy <- function(x) {
    m2(apply(x, 2, mean))
}

plotall <- function(x) {
  
  plot(x$verts, cex = 2)
  doh <- lapply(seq_along(x$boxind), function(i) polygon(x$verts[x$boxind[[i]], ], col = scol()))
  doh <- lapply(x$faceind, function(a) lines(x$verts[a, ], lwd = 3))
points(x$verts[x$bndind, ], pch = 16)

doh <- lapply(seq_along(x$faceind), function(a) text(meanxy(x$verts[x$faceind[[a]], ]), cex = 0.7, lab = as.character(a-1), col = "darkgrey") )


doh <- lapply(seq_along(x$boxind), function(a) text(meanxy(x$verts[x$boxind[[a]], ]), cex = 0.7,  lab = as.character(a-1)) )
invisible(NULL)
}
```

## Box Geometry Model files

BGM files store the "box geometry" for Atlantis ecosystem models. These consist of **boxes** (polygons) composed of **faces** (line segments composing individual polygon edges) and and overall **boundary** that delimits the domain of the model. 

The boundary is composed of boundary polygons that are not boxes in the model, but some box edges are on this boundary (this needs some clarification.)

We read in some examples. The **rbgm** package includes tools to read the BGM format, it returns a table of all X/Y vertices and lists of indices for the boxes and faces. (This is work in progress which will include the boundary and all attributes in the format). 

These are the box attributes: 

Name  | Description | Source
------------- | -------------
label  | Box0 etc. | boxid input
inside  | coordinate (intersecting centroid) | implicit
nconn  | number of faces and "connecting" boxes | implicit
iface  | index of the faces (nconn) | implicit
ibox  | index of the connecting boxes (ncoon) | implicit
botz  | depth of the box | botz input
area  | area of the box (in units of the vertices) | implicit
vertmix  | vertical mixing | input
horizmix  | horizontal mixing | input
vert.0  | first vertex | input
vert.1  | second vertex etc. | input


```{r}

f1 <- system.file("extdata/EastAntarctica_LL.bgm", package = "rbgm")
library(rbgm)
b1 <- read_bgm(f1)

```

Plot the elements of the BGM format. Faces are shown as thick black lines, filled points are vertices on non-boundary boxes, open points are boundary vertices, black labels are box IDs (starting at 0), grey labels are face IDs (starting at 0). 

```{r}
plotall(b1)



```
